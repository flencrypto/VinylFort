<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>My Collection - VinylVault Pro</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Preload critical resources -->
    <link rel="preload" href="components/vinyl-nav.js" as="script" />
    <link rel="preload" href="components/vinyl-footer.js" as="script" />
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
      if (typeof tailwind !== "undefined")
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              fontFamily: {
                sans: ['Inter', 'system-ui', 'sans-serif'],
              },
              colors: {
                primary: "#7c3aed",
                secondary: "#06b6d4",
                accent: "#f59e0b",
                surface: "#0f172a",
                "surface-light": "#1e293b",
                profit: "#22c55e",
                loss: "#ef4444",
              },
            },
          },
        };
    </script>
  </head>
  <body class="bg-surface text-gray-100 min-h-screen">
    <a href="#main-content" class="skip-link">Skip to content</a>
    <!-- Navigation -->
    <vinyl-nav></vinyl-nav>

    <!-- Main Content -->
    <main id="main-content" class="pt-20 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
      <!-- Page Header -->
      <section class="mb-8">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div>
            <h1
              class="text-3xl font-bold bg-gradient-to-r from-primary via-secondary to-accent bg-clip-text text-transparent mb-2"
            >
              My Collection
            </h1>
            <p class="text-gray-400">
              Catalogue, track profits, and manage your vinyl inventory
            </p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button
              onclick="document.getElementById('jsonImportInput').click()"
              class="px-4 py-2 bg-surface-light border border-gray-600 rounded-lg font-medium hover:border-secondary hover:text-secondary transition-all flex items-center gap-2"
              title="Import from backup"
            >
              <i data-feather="download" class="w-4 h-4"></i>
              Import Backup
            </button>
            <input
              type="file"
              id="jsonImportInput"
              accept=".json"
              class="hidden"
              onchange="importCollectionFromJSON(this.files[0])"
              aria-label="Import collection backup JSON"
            />
            <button
              onclick="window.location.href = 'deals.html'"
              class="px-4 py-2 bg-surface-light border border-deal/50 text-deal rounded-lg font-medium hover:bg-deal/10 transition-all flex items-center gap-2"
            >
              <i data-feather="search" class="w-4 h-4"></i>
              Find Deals
            </button>
            <button
              onclick="showImportModal()"
              class="px-4 py-2 bg-surface-light border border-gray-600 rounded-lg font-medium hover:border-primary hover:text-primary transition-all flex items-center gap-2"
            >
              <i data-feather="upload" class="w-4 h-4"></i>
              Import Discogs CSV
            </button>
            <button
              onclick="exportCollection()"
              class="px-4 py-2 bg-surface-light border border-gray-600 rounded-lg font-medium hover:border-accent hover:text-accent transition-all flex items-center gap-2"
              title="Export backup"
            >
              <i data-feather="save" class="w-4 h-4"></i>
              Export
            </button>
            <button
              onclick="addRecordManually()"
              class="px-4 py-2 bg-gradient-to-r from-primary to-purple-600 rounded-lg font-medium hover:shadow-lg hover:shadow-primary/25 transition-all flex items-center gap-2"
            >
              <i data-feather="plus" class="w-4 h-4"></i>
              Add Record
            </button>
          </div>
        </div>
      </section>

      <!-- Portfolio Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <stat-card
          icon="disc"
          label="Total Records"
          value="0"
          id="totalRecords"
          trend="in collection"
        ></stat-card>
        <stat-card
          icon="pound-sign"
          label="Total Invested"
          value="£0.00"
          id="totalInvested"
          trend="cost basis"
        ></stat-card>
        <stat-card
          icon="trending-up"
          label="Est. Value"
          value="£0.00"
          id="totalValue"
          trend="current market"
        ></stat-card>
        <stat-card
          icon="percent"
          label="Portfolio Return"
          value="+0%"
          id="portfolioReturn"
          trend="unrealized"
        ></stat-card>
      </div>

      <!-- Filters & Search -->
      <div class="bg-surface-light rounded-xl p-4 border border-gray-800 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1 relative">
            <i
              data-feather="search"
              class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"
            ></i>
            <input
              type="text"
              id="collectionSearch"
              placeholder="Search artist, title, catalogue number..."
              class="w-full pl-10 pr-4 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
              aria-label="Search collection"
              oninput="filterCollection()"
            />
          </div>
          <div class="flex gap-3">
            <select
              id="statusFilter"
              onchange="filterCollection()"
              class="px-4 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
              aria-label="Filter collection status"
            >
              <option value="all">All Status</option>
              <option value="owned">Owned</option>
              <option value="listed">Listed</option>
              <option value="sold">Sold</option>
            </select>
            <select
              id="sortBy"
              onchange="sortCollection()"
              class="px-4 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
              aria-label="Sort collection"
            >
              <option value="dateAdded">Date Added</option>
              <option value="artist">Artist A-Z</option>
              <option value="purchasePrice">Purchase Price</option>
              <option value="estValue">Est. Value</option>
              <option value="profit">Profit Potential</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Skeleton Loading State -->
      <div id="collectionSkeleton" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>

      <!-- Empty State -->
      <div id="collectionEmptyState" class="hidden text-center py-16">
        <div class="w-24 h-24 mx-auto mb-6 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="96" height="96" aria-hidden="true">
            <circle cx="50" cy="50" r="48" fill="none" stroke="#334155" stroke-width="4"/>
            <circle cx="50" cy="50" r="32" fill="none" stroke="#334155" stroke-width="4"/>
            <circle cx="50" cy="50" r="6" fill="#334155"/>
          </svg>
        </div>
        <h3 class="text-xl font-medium text-gray-300 mb-2">Your collection is empty</h3>
        <p class="text-gray-400 max-w-md mx-auto mb-6">
          Scan your first record or import a backup to get started.
        </p>
        <a href="index.html" class="inline-block px-6 py-3 bg-primary/20 text-primary rounded-lg hover:bg-primary/30 transition-all font-medium">
          Create Your First Listing
        </a>
      </div>

      <!-- Collection Grid -->
      <div
        id="collectionGrid"
        class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"
      >
      </div>
    </main>

    <!-- Import Modal -->
    <div
      id="importModal"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-surface-light rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden border border-gray-800"
      >
        <div
          class="p-6 border-b border-gray-800 flex items-center justify-between"
        >
          <h2 class="text-xl font-semibold">Import Discogs Collection</h2>
          <button
            onclick="hideImportModal()"
            class="text-gray-400 hover:text-white"
          >
            <i data-feather="x" class="w-6 h-6"></i>
          </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh]">
          <div class="space-y-6">
            <!-- Step 1 -->
            <div class="flex gap-4">
              <div
                class="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0"
              >
                <span class="text-sm font-bold">1</span>
              </div>
              <div>
                <h3 class="font-medium text-gray-200 mb-1">
                  Export from Discogs
                </h3>
                <p class="text-sm text-gray-400 mb-3">
                  Go to your Discogs collection and export as CSV format.
                </p>
                <a
                  href="https://www.discogs.com/users/export"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-primary hover:underline text-sm flex items-center gap-1"
                >
                  Open Discogs Export
                  <i data-feather="external-link" class="w-3 h-3"></i>
                </a>
              </div>
            </div>

            <!-- Step 2 -->
            <div class="flex gap-4">
              <div
                class="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0"
              >
                <span class="text-sm font-bold">2</span>
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-gray-200 mb-1">Upload CSV File</h3>
                <p class="text-sm text-gray-400 mb-3">
                  Select your exported Discogs CSV file.
                </p>
                <div
                  class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center hover:border-primary hover:bg-primary/5 transition-all cursor-pointer"
                  onclick="document.getElementById('csvInput').click()"
                >
                  <i
                    data-feather="file-text"
                    class="w-10 h-10 text-gray-500 mx-auto mb-3"
                  ></i>
                  <p class="text-gray-300 font-medium">
                    Click to select CSV file
                  </p>
                  <p class="text-xs text-gray-500 mt-1">
                    or drag and drop here
                  </p>
                  <input
                    type="file"
                    id="csvInput"
                    accept=".csv"
                    class="hidden"
                    onchange="handleCSVUpload(event)"
                    aria-label="Upload Discogs CSV"
                  />
                </div>
              </div>
            </div>

            <!-- Step 3 -->
            <div class="flex gap-4">
              <div
                class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0"
              >
                <span class="text-sm font-bold">3</span>
              </div>
              <div>
                <h3 class="font-medium text-gray-200 mb-1">
                  Review & Add Photos
                </h3>
                <p class="text-sm text-gray-400">
                  We'll import your collection and prompt for photos to verify
                  each record.
                </p>
              </div>
            </div>
          </div>

          <!-- Preview Section -->
          <div
            id="csvPreview"
            class="hidden mt-6 pt-6 border-t border-gray-800"
          >
            <h3 class="font-medium text-gray-200 mb-3">
              Preview (<span id="previewCount">0</span> records found)
            </h3>
            <div class="bg-surface rounded-lg p-4 max-h-48 overflow-y-auto">
              <table class="w-full text-sm">
                <thead class="text-gray-500 border-b border-gray-700">
                  <tr>
                    <th class="text-left py-2">Artist</th>
                    <th class="text-left py-2">Title</th>
                    <th class="text-right py-2">Year</th>
                  </tr>
                </thead>
                <tbody id="previewTableBody" class="text-gray-300"></tbody>
              </table>
            </div>
            <div class="flex gap-3 mt-4">
              <button
                onclick="processCSVImport()"
                class="flex-1 px-4 py-2 bg-primary rounded-lg font-medium hover:bg-primary/90 transition-all"
              >
                Start Import (<span id="previewCountConfirm">0</span> records)
              </button>
              <button
                onclick="cancelImport()"
                class="px-4 py-2 border border-gray-600 rounded-lg hover:border-red-500 hover:text-red-400 transition-all"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Record Detail Modal -->
    <div
      id="recordModal"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-surface-light rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-gray-800"
      >
        <div id="recordModalContent">
          <!-- Dynamically populated -->
        </div>
      </div>
    </div>

    <!-- Photo Verification Modal -->
    <div
      id="photoVerifyModal"
      class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-surface-light rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden border border-gray-800"
      >
        <div
          class="p-6 border-b border-gray-800 flex items-center justify-between"
        >
          <div>
            <h2 class="text-xl font-semibold">Verify Record Details</h2>
            <p class="text-sm text-gray-400" id="verifyRecordName">
              Artist - Title
            </p>
          </div>
          <button
            onclick="skipPhotoVerification()"
            class="text-gray-400 hover:text-white"
          >
            <i data-feather="x" class="w-6 h-6"></i>
          </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[70vh]">
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Left: Form -->
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-gray-400 mb-1"
                    >Purchase Price (£)</label
                  >
                  <input
                    type="number"
                    id="verifyPurchasePrice"
                    step="0.01"
                    class="w-full px-3 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
                    aria-label="Purchase price"
                  />
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-1"
                    >Purchase Date</label
                  >
                  <input
                    type="date"
                    id="verifyPurchaseDate"
                    class="w-full px-3 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
                    aria-label="Purchase date"
                  />
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1"
                  >Purchase Source</label
                >
                <select
                  id="verifySource"
                  class="w-full px-3 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
                  aria-label="Source marketplace"
                >
                  <option value="discogs">Discogs</option>
                  <option value="ebay">eBay</option>
                  <option value="record_store">Record Store</option>
                  <option value="charity_shop">Charity Shop</option>
                  <option value="car_boot">Car Boot Sale</option>
                  <option value="inheritance">Inherited/Gift</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1"
                  >Condition (Vinyl/Sleeve)</label
                >
                <div class="grid grid-cols-2 gap-3">
                  <select
                    id="verifyVinylCondition"
                    class="px-3 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
                    aria-label="Vinyl condition"
                  >
                    <option value="M">M (Mint)</option>
                    <option value="NM">NM (Near Mint)</option>
                    <option value="VG+">VG+ (Very Good Plus)</option>
                    <option value="VG" selected>VG (Very Good)</option>
                    <option value="G+">G+ (Good Plus)</option>
                    <option value="G">G (Good)</option>
                    <option value="F">F (Fair)</option>
                    <option value="P">P (Poor)</option>
                  </select>
                  <select
                    id="verifySleeveCondition"
                    class="px-3 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm"
                    aria-label="Sleeve condition"
                  >
                    <option value="M">M (Mint)</option>
                    <option value="NM">NM (Near Mint)</option>
                    <option value="VG+">VG+ (Very Good Plus)</option>
                    <option value="VG" selected>VG (Very Good)</option>
                    <option value="G+">G+ (Good Plus)</option>
                    <option value="G">G (Good)</option>
                    <option value="F">F (Fair)</option>
                    <option value="P">P (Poor)</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Notes</label>
                <textarea
                  id="verifyNotes"
                  rows="3"
                  class="w-full px-3 py-2 bg-surface border border-gray-700 rounded-lg focus:border-primary focus:outline-none text-sm resize-none"
                  aria-label="Verification notes"
                ></textarea>
              </div>
            </div>
            <!-- Right: Photo Upload -->
            <div>
              <label class="block text-sm text-gray-400 mb-2"
                >Upload Photos for Verification</label
              >
              <div
                id="verifyDropZone"
                class="border-2 border-dashed border-gray-600 rounded-xl p-6 text-center hover:border-primary hover:bg-primary/5 transition-all cursor-pointer"
                onclick="document.getElementById('verifyPhotoInput').click()"
              >
                <i
                  data-feather="camera"
                  class="w-8 h-8 text-gray-500 mx-auto mb-2"
                ></i>
                <p class="text-sm text-gray-400">
                  Drop photos or click to browse
                </p>
                <p class="text-xs text-gray-600 mt-1">
                  Front, back, labels recommended
                </p>
                <input
                  type="file"
                  id="verifyPhotoInput"
                  multiple
                  accept="image/*"
                  class="hidden"
                  onchange="handleVerifyPhotos(event)"
                  aria-label="Upload verification photos"
                />
              </div>
              <div id="verifyPhotoGrid" class="grid grid-cols-3 gap-2 mt-3">
                <!-- Photo previews -->
              </div>
            </div>
          </div>
          <div class="flex gap-3 mt-6 pt-4 border-t border-gray-800">
            <button
              onclick="saveVerifiedRecord()"
              class="flex-1 px-4 py-2 bg-gradient-to-r from-primary to-purple-600 rounded-lg font-medium hover:shadow-lg hover:shadow-primary/25 transition-all flex items-center justify-center gap-2"
            >
              <i data-feather="check" class="w-4 h-4"></i>
              Save & Analyze
            </button>
            <button
              onclick="skipPhotoVerification()"
              class="px-4 py-2 border border-gray-600 rounded-lg hover:border-gray-500 transition-all"
            >
              Skip for Now
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <vinyl-footer></vinyl-footer>

    <!-- Components -->
    <script src="components/vinyl-nav.js"></script>
    <script src="components/vinyl-footer.js"></script>
    <script src="components/stat-card.js"></script>
    <script src="components/collection-service.js"></script>

    <!-- Main Script -->
    <script src="script.js"></script>
    <script src="collection.js"></script>
    <script>
      feather.replace();
    </script>
    <!-- ElevenLabs Conversational AI Widget -->
    <elevenlabs-convai
      agent-id="agent_9101kgpbsbwkfazrdcnxxddsnk1c"
    ></elevenlabs-convai>
    <script
      src="https://unpkg.com/@elevenlabs/convai-widget-embed"
      async
      type="text/javascript"
    ></script>

    <!-- Widget Configuration Script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const widget = document.querySelector("elevenlabs-convai");

        if (widget) {
          // Listen for the widget's "call" event to trigger client-side tools
          widget.addEventListener("elevenlabs-convai:call", (event) => {
            event.detail.config.clientTools = {
              // Client tool to redirect to external URLs
              redirectToExternalURL: ({ url }) => {
                window.open(url, "_blank", "noopener,noreferrer");
              },
            };
          });
        }
      });
    </script>
  </body>
</html>
